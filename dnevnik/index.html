<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        h1, h2, h3 {
            text-align: center;
        }
        .no-lesson {
            color: #888;
            font-style: italic;
        }
        .error {
            color: red;
            text-align: center;
        }
        .info {
            text-align: center;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Расписание</h1>
    <div id="main-schedule"></div>
    <h3>Расписание элективов</h3>
    <div id="electives-schedule"></div>

    <script>
        // URL для основного расписания и расписания элективов
        const MAIN_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1lWqIJaWWXceiE_CWyIdzMRLcRoQa-ulnT5tJfgLDo0o/export?format=csv&gid=0';
        const ELECTIVES_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1qS4JSUM2DqFgZhmiMfaJ8VU-t2DvpRtJyadEQkdxujA/export?format=csv';

        // Расписание звонков
        const SCHEDULE_WEEKDAYS = {
            '0 урок': '7:45–8:25',
            '1 урок': '8:30–9:10',
            '2 урок': '9:20–10:00',
            '3 урок': '10:15–10:55',
            '4 урок': '11:15–11:55',
            '5 урок': '12:15–12:55',
            '6 урок': '13:05–13:45',
            '7 урок': '13:55–14:35',
            '8 урок': '14:45–15:20'
        };

        const SCHEDULE_SATURDAY = {
            '0 урок': '7:45–8:25',
            '1 урок': '8:30–9:10',
            '2 урок': '9:20–10:00',
            '3 урок': '10:15–10:55',
            '4 урок': '11:10–11:50',
            '5 урок': '12:05–12:45',
            '6 урок': '12:55–13:35',
            '7 урок': '13:45–14:25',
            '8 урок': '14:45–15:20'
        };

        async function fetchSchedule(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Не удалось загрузить данные: ' + response.status);
                }
                const text = await response.text();
                console.log('Полученные данные (сырой CSV):', text); // Для отладки
                const data = parseCSV(text);
                console.log('Распарсенные данные:', data); // Для отладки
                return data;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                return null;
            }
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if (char === '\n' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            return rows;
        }

        function getDayWithTimeShift() {
            const now = new Date();
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const utcPlus5Time = new Date(utcTime + (5 * 60 * 60 * 1000));

            let dayIndex = utcPlus5Time.getDay();
            const hours = utcPlus5Time.getHours();
            const minutes = utcPlus5Time.getMinutes();
            console.log('Текущее время в UTC+5:', `${hours}:${minutes}`);

            if (dayIndex === 0) {
                return {
                    displayDayIndex: 1, // Понедельник
                    isSunday: true
                };
            }

            const isAfter16 = (hours > 16) || (hours === 16 && minutes >= 0);
            if (isAfter16) {
                dayIndex = (dayIndex + 1) % 7;
            }

            return {
                displayDayIndex: dayIndex,
                isSunday: false
            };
        }

        function displaySchedule(data, containerId, title) {
            const { displayDayIndex, isSunday } = getDayWithTimeShift();
            const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const currentDay = days[displayDayIndex];
            
            console.log(`Отображаемый день для ${title}:`, currentDay);

            const headerRow = data[0] || [];
            console.log(`Заголовки таблицы (${title}):`, headerRow);
            const dayIndex = headerRow.indexOf(currentDay);

            if (dayIndex === -1) {
                console.log(`Дни в таблице (${title}):`, headerRow);
                document.getElementById(containerId).innerHTML = `<p class="error">Данные для текущего дня (${currentDay}) не найдены</p>`;
                return;
            }

            // Выбираем расписание звонков в зависимости от дня
            const scheduleTimes = displayDayIndex === 6 ? SCHEDULE_SATURDAY : SCHEDULE_WEEKDAYS;

            let html = `<h2>${currentDay}</h2>`;
            if (isSunday) {
                html += `<p class="info">Сегодня воскресенье, показываем расписание на понедельник.</p>`;
            }
            html += `<table>`;
            html += `
                <tr>
                    <th>Урок</th>
                    <th>Время</th>
                    <th>Предмет</th>
                </tr>
            `;

            for (let i = 1; i < data.length; i++) {
                const lessonWithTime = data[i][0] || '';
                const subject = data[i][dayIndex] || '';

                // Извлекаем номер урока (без времени)
                const match = lessonWithTime.match(/(.*)\s*\((.*)\)/);
                const lesson = match ? match[1].trim() : lessonWithTime;

                // Получаем время из расписания звонков
                const time = scheduleTimes[lesson] || '-';

                if (lesson) {
                    html += `
                        <tr>
                            <td>${lesson}</td>
                            <td>${time}</td>
                            <td>${subject || '<span class="no-lesson">Нет урока</span>'}</td>
                        </tr>
                    `;
                }
            }
            
            html += '</table>';
            document.getElementById(containerId).innerHTML = html;
        }

        async function loadSchedules() {
            const mainData = await fetchSchedule(MAIN_SHEET_URL);
            const electivesData = await fetchSchedule(ELECTIVES_SHEET_URL);

            if (mainData) {
                displaySchedule(mainData, 'main-schedule', 'Обычное расписание');
            } else {
                document.getElementById('main-schedule').innerHTML = `<p class="error">Не удалось загрузить обычное расписание</p>`;
            }

            if (electivesData) {
                displaySchedule(electivesData, 'electives-schedule', 'Расписание элективов');
            } else {
                document.getElementById('electives-schedule').innerHTML = `<p class="error">Не удалось загрузить расписание элективов</p>`;
            }
        }

        loadSchedules();
        setInterval(loadSchedules, 300000);
    </script>
</body>
</html>
